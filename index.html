<!DOCTYPE html>
<html lang="en">

<head>
    <title>Danny Elfman</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
    <link rel="preload" href="DIN-BoldAlternate.otf" as="font" crossorigin="anonymous" />
    <link type="text/css" rel="stylesheet" href="main.css">
    <style>
        body {
            background-color: #000000;
            color: #444;
            font-family: 'DIN';

        }

        a {
            color: #08f;
        }

        #container {
            display: block;
            left: 0px;
            top: 0px;
        }

        @font-face {
            font-family: 'DIN';
            src: url(DIN-BoldAlternate.otf);
        }

        #frontText {
            position: absolute;
            top: 0%;
            left: 50%;
            transform: translate(-50%, 60%);
            font-size: 50px;
            font-family: 'DIN';
            color: #000000;
            text-align: center;
            z-index: 100;
        }

        #progress {
            position: absolute;
            height: 10px;
            top: 50%;
            margin-top: -5px;
            background: rgb(255, 255, 255);
        }

        #startButton {
            position: absolute;
            height: 20px;
            width: 100px;
            top: 50%;
            left: 50%;
            margin-left: -50px;
            margin-top: -10px;
            background: rgb(0, 0, 0);
            text-align: center;
            vertical-align: middle;
            line-height: 20px;

        }

        #progressText {
            position: absolute;
            height: 20px;
            width: 100px;
            top: 50%;
            left: 50%;
            margin-left: -50px;
            margin-top: -10px;
            background: rgb(0, 0, 0);
            color: #fff;
            text-align: center;
            vertical-align: middle;
            line-height: 20px;

        }


        #startButton {
            color: #fff;
        }
    </style>
</head>

<body>


    <div id="frontText"></div>
    <div id="load">
        <div id="progress"></div>
        <div id="progressText">LOADING...</div>
        <a id="startButton" style="display:none">ENTER</a>
    </div>

    <!-- Import maps polyfill -->
    <!-- Remove this when import maps will be widely supported -->
    <script async src="https://unpkg.com/es-module-shims@1.6.3/dist/es-module-shims.js"></script>

    <script type="importmap">
			{
				"imports": {
					"three": "./lib/three.module.js",
					"three/addons/": "./lib/"
				}
			}
	</script>



    <script type="module">

        var lib = './lib/';

        import * as THREE from 'three';

        import $ from "./lib/jquery.module.js";

        import Stats from './lib/stats.module.js';
        import ObjectControls from './lib/ObjectControls.js'
        import AudioBuffer from './lib/AudioBuffer.js'
        import AudioController from './lib/AudioController.js'
        import BufferedAudio from './lib/BufferedAudio.js'
        import { OBJLoader } from './lib/OBJLoader.js';
        import { GLTFLoader } from './lib/GLTFLoader.js';
        import MouseMoveControls from './lib/MouseMoveControls.js'
        import TextCreator from './lib/TextCreator.js'
        import { OrbitControls } from './lib/OrbitControls.js'

        import Looper from './lib/Looper.js'

        import AudioLoop from './lib/AudioLoop.js'
        import SkullLink from './lib/SkullLink.js'

        import unmute from './lib/unmute.js'


        import vs1 from './shaders/vs-trace.js'
        import vs2 from './shaders/vs-basic.js'
        import fs1 from './shaders/fs-trace.js'
        import fs2 from './shaders/fs-trace2.js'
        import fs3 from './shaders/fs-trace3.js'



        /* Order of Hand Links
                "MERCH",
                "MEDIA",
                "EVENTS",
                "ABOUT"
            */
        var HAND_LINKS = [
            "https://www.dannyelfman.com/merch", // MERCH link
            "https://www.dannyelfman.com/media-all", // MEDIA link
            "https://www.dannyelfman.com/events", // EVENTS link
            "https://www.dannyelfman.com/about" // ABOUT link
        ];



        /* ORDER OF LINKS
                  "MISC",
                  "CLASSICAL",
                  "FILM",
                  "ROCK"
          */
        var MUSIC_LINKS = [
            "https://www.dannyelfman.com/misc", // MISC link
            "https://www.dannyelfman.com/classical", // CLASSICAL link
            "https://www.dannyelfman.com/filmscores", // FILM link
            "https://www.dannyelfman.com/rock" // ROCK link
        ]

        // override cuz im useless
        print = console.log;

        let clickCutoff = 100;

        let container, stats;
        let camera, scene, raycaster, renderer;

        let audio;

        let tv1 = new THREE.Vector3();
        let tv2 = new THREE.Vector3();
        let looper;

        let INTERSECTED;
        let theta = 0;

        const pointer = new THREE.Vector2();
        const radius = 100;
        let controls;
        var camControls;
        let clock = new THREE.Clock();

        clock.deltaTime = 0;




        let manager = new THREE.LoadingManager();

        // get element by id
        var progress = document.getElementById('progress');
        var progressText = document.getElementById('progressText');
        var startButton = document.getElementById('startButton');
        var loadDiv = document.getElementById('load');


        startButton.onclick = function () {
            progress.display = 'none';
            progressText.display = 'none';
            loadDiv.style.display = 'none';
            init();
            audio.ctx.resume();
            animate();
        }

        manager.onProgress = function (url, itemsLoaded, itemsTotal) {
            progress.style.width = (itemsLoaded / itemsTotal * 100) + '%';
            //console.log(url);
            //console.log("PROGGERS  :" + (itemsLoaded / itemsTotal * 100) + '%');
        };

        manager.onLoad = function () {

            //console.log("lads");
            startButton.style.display = 'block';
            progressText.style.display = 'none';
            loadDiv.style.display = 'block';
            //init();
            //audio.ctx.resume();
            //animate();

        }



        // instantiate a loader
        const audioLoader = new THREE.AudioLoader(manager);
        const textureLoader = new THREE.TextureLoader(manager);
        const objLoader = new OBJLoader(manager);
        const gltfLoader = new GLTFLoader(manager);



        const audioSamples = {}
        const stems = [];

        const textures = {}
        const models = {}

        models.words = {}
        const audioLoopObjects = [];

        var rings;


        window.mobileCheck = function () {
            let check = false;
            (function (a) { if (/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows ce|xda|xiino/i.test(a) || /1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(a.substr(0, 4))) check = true; })(navigator.userAgent || navigator.vendor || window.opera);
            return check;
        };

        var farZoom = 140;
        var closeZoom = 5;

        if (window.mobileCheck()) {
            //print("IS MOBILE");
            farZoom = 200;
        } else {
            //print("NOT MOBILE");
        }




        /*


        
 _       ___    ____  ___   
| |     /   \  /    ||   \  
| |    |     ||  o  ||    \ 
| |___ |  O  ||     ||  D  |
|     ||     ||  _  ||     |
|     ||     ||  |  ||     |
|_____| \___/ |__|__||_____|
        
*/

        function load() {

            audioLoader.load('./audio/01 Melodic Enter.wav', function (buffer) {
                // console.log("loaded audio");
                audioSamples.enter1 = buffer;
            });


            audioLoader.load('./audio/musicStems/stem 1.mp3', function (buffer) {
                // console.log("loaded audio");
                audioSamples.stem1 = buffer;
                stems[5] = buffer;
            });

            audioLoader.load('./audio/musicStems/stem 2.mp3', function (buffer) {
                //console.log("loaded audio");
                audioSamples.stem2 = buffer;
                stems[1] = buffer;
            });


            audioLoader.load('./audio/musicStems/stem 3.mp3', function (buffer) {
                // console.log("loaded audio");
                audioSamples.stem3 = buffer;
                stems[2] = buffer;
            });


            audioLoader.load('./audio/musicStems/stem 4.mp3', function (buffer) {
                //console.log("loaded audio");
                audioSamples.stem4 = buffer;
                stems[3] = buffer;
            });


            audioLoader.load('./audio/musicStems/stem 5.mp3', function (buffer) {
                //console.log("loaded audio");
                audioSamples.stem5 = buffer;
                stems[4] = buffer;
            });

            audioLoader.load('./audio/musicStems/stem 6.mp3', function (buffer) {
                //console.log("loaded audio");
                audioSamples.stem6 = buffer;
                stems[0] = buffer;
            });


            audioLoader.load('./audio/musicStems/stem 7.mp3', function (buffer) {
                // console.log("loaded audio");
                audioSamples.stem7 = buffer;
                stems[6] = buffer;
            });



            textureLoader.load('./img/rough-aluminium.jpg', function (texture) {
                textures.matcap = texture;
            });

            textureLoader.load('./img/flare.png', function (texture) {
                textures.flare = texture;
            });

            textureLoader.load('./img/t_n_snakeSkin.png', function (texture) {
                texture.wrapS = THREE.RepeatWrapping;
                texture.wrapT = THREE.RepeatWrapping;
                textures.normal = texture;
            });


            textureLoader.load('./img/rings.png', function (texture) {
                textures.ring1 = texture;
            });

            textureLoader.load('./img/rings3.png', function (texture) {
                textures.ring2 = texture;
            });

            textureLoader.load('./img/eye_05_basecolor.png', function (texture) {
                textures.eyeball = texture;
            });

            textureLoader.load('./img/rainbowGradient.png', function (texture) {
                texture.wrapS = THREE.RepeatWrapping;
                texture.wrapT = THREE.RepeatWrapping;
                textures.colormap = texture;
            });
            objLoader.load('./models/handClean1.obj', function (object) {
                models.hand = object;
            });


            objLoader.load('./models/SKULL/skull.obj', function (object) {
                models.skull = object;

            });

            objLoader.load('./models/SKULL/musicText.obj', function (object) {
                models.skullWords = object;
            });

            objLoader.load('./models/SKULL/skullLow.obj', function (object) {
                //print("LAODS");
                //print(object);
                models.skullShield = object.children[0];
            });


            /*gltfLoader.load('./models/SKULL/justSkull.glb', function (object) {
                models.glbSkull = object.scene;
            });

            gltfLoader.load('./models/SKULL/musicWords.glb', function (object) {
                models.glbMusic = object.scene;
            });*/


            gltfLoader.load('./models/eyeball.glb', function (object) {
                models.eyeball = object.scene;
            });


            gltfLoader.load('./models/musicSkull.glb', function (object) {
                //print(object.scene);
                models.glbSkull = object.scene.children[1];
                models.glbMusic = object.scene.children[0];
                //models.eyeball = object.scene;
            });
            objLoader.load('./models/wordModels/classical01_lowres_nrmls.obj', function (object) {
                models.words.classical = object;
            });

            objLoader.load('./models/wordModels/convexhull/classical_hull.obj', function (object) {
                models.words.classicalHull = object;
            });

            objLoader.load('./models/wordModels/rock06_lowres_nrmls.obj', function (object) {
                models.words.rock = object;
            });

            objLoader.load('./models/wordModels/convexhull/rock_hull.obj', function (object) {
                models.words.rockHull = object;
            });


            objLoader.load('./models/wordModels/film02_lowres_nrmls.obj', function (object) {
                models.words.film = object;
            });

            objLoader.load('./models/wordModels/convexhull/film_hull.obj', function (object) {
                models.words.filmHull = object;
            });


            objLoader.load('./models/wordModels/misc02_lowres_nrmls.obj', function (object) {
                models.words.misc = object;
            });

            objLoader.load('./models/wordModels/convexhull/misc_hull.obj', function (object) {
                models.words.miscHull = object;
            });


            objLoader.load('./models/wordModels/music04_lowres_nrmls.obj', function (object) {
                models.words.music = object;
            });

            objLoader.load('./models/wordModels/convexhull/music_hull.obj', function (object) {
                models.words.musicHull = object;
            });






        }






        load();


        var cornerLinks = [];
        var musicCornerLinks = [];
        var mainSkull;


        var uniforms = {

            dT: { type: "f", value: 0 },
            time: { type: "f", value: 0 },
            lightPos: { type: "v3", value: null },
            t_matcap: { type: "t", value: textures.matcap },
            t_normal: { type: "t", value: textures.normal },
            t_audio: { type: "t", value: null },
            t_colormap: { type: "t", value: null },

        }



        function init() {


            audio = new AudioController();
            audio.samples = {};
            uniforms.t_audio.value = audio.texture;


            uniforms.t_matcap.value = textures.matcap;
            uniforms.t_normal.value = textures.normal;
            uniforms.t_colormap.value = textures.colormap;


            container = document.createElement('div');
            container.id = 'container';
            document.body.appendChild(container);

            camera = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 1, 10000);

            controls = new ObjectControls(camera);

            controls.sceneDistance = 100;
            controls.update();

            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x000);

            camControls = new OrbitControls(camera, container);
            camControls.maxZoom = 10;
            camControls.desiredZoom = farZoom;
            camControls.enableDamping = true;
            camControls.enablePan = false;
            camControls.enableZoom = true;
            camControls.dampingFactor = .04;
            camControls.lerpTarget = new THREE.Vector3(0, 0, 0);
            camControls.lerpingToTarget = false;


            camera.position.set(0, 0, farZoom);

            clock = new THREE.Clock();
            clock.start();



            const geometry = new THREE.BoxGeometry(20, 20, 20);

            /*
            
                __   ___   ____   ____     ___  ____       _      ____  ____   __  _   _____
               /  ] /   \ |    \ |    \   /  _]|    \     | |    |    ||    \ |  |/ ] / ___/
              /  / |     ||  D  )|  _  | /  [_ |  D  )    | |     |  | |  _  ||  ' / (   \_ 
             /  /  |  O  ||    / |  |  ||    _]|    /     | |___  |  | |  |  ||    \  \__  |
            /   \_ |     ||    \ |  |  ||   [_ |    \     |     | |  | |  |  ||     \ /  \ |
            \     ||     ||  .  \|  |  ||     ||  .  \    |     | |  | |  |  ||  .  | \    |
             \____| \___/ |__|\_||__|__||_____||__|\_|    |_____||____||__|__||__|\_|  \___|
            
            
            
            */

            var corners = getScreenCornersInWorld(camera, 100, 1);

            //console.log(models.hand.children[0].geometry);



            var linkInfo = [
                "ELF-STORE",
                "MEDIA",
                "EVENTS",
                "ABOUT"
            ]

            var textCreator = new TextCreator(10);
            textCreator.font = "DIN"


            var transparentMaterial = new THREE.MeshBasicMaterial({
                transparent: true,
                opacity: 0,
                depthWrite: false,
            });

            var angleSize = 1;
            var angleStart = 0.12;
            var corners = getPositionsAroundSkull(50.5, angleSize, angleStart, 0);

            var cornerRotations = getRotationsAroundSkull(angleSize, angleStart);




            for (var i = 0; i < 4; i++) {

                var handMaterial = new THREE.ShaderMaterial({
                    uniforms: {

                        dT: uniforms.dT,
                        time: uniforms.time,
                        lightPos: uniforms.lightPos,
                        t_matcap: uniforms.t_matcap,
                        t_normal: uniforms.t_normal,
                        t_audio: uniforms.t_audio,
                        t_colormap: uniforms.t_colormap,

                        _NoiseSize: { type: "f", value: .05 },
                        _NoiseSpeed: { type: "f", value: .3 },
                        _NoiseOffset: { type: "f", value: 1.4 },
                        _HueStart: { type: "f", value: .4 },
                        _HueSize: { type: "f", value: .03 },
                        _NormalDepth: { type: "f", value: .1 },
                        _FFTStart: { type: "f", value: .1 },
                        _FFTSize: { type: "f", value: 1.1 },
                        _Saturation: { type: "f", value: 1 },
                        _Lightness: { type: "f", value: 2 },
                        _DiscardAmount: { type: "f", value: 1 }

                    },
                    vertexShader: vs1,
                    fragmentShader: fs1,
                    side: THREE.DoubleSide
                })

                handMaterial.extensions.derivatives = true;


                var text = textCreator.createMesh(linkInfo[i]);
                text.position.set(0, 0, 0);
                text.position.set(corners[i].x, corners[i].y, corners[i].z);
                scene.add(text);
                var hand = new THREE.Mesh(models.hand.children[0].geometry, handMaterial);
                //  console.log(corners[i]);


                hand.scale.x = 2;
                hand.scale.y = 2;
                hand.scale.z = 2;

                hand.position.set(corners[i].x, corners[i].y, corners[i].z);

                text.hand = hand;
                text.scale.multiplyScalar(1);

                scene.add(text);
                scene.add(hand);


                var touchSphere = new THREE.Mesh(new THREE.IcosahedronGeometry(1.8, 2), transparentMaterial);
                touchSphere.hand = hand;
                touchSphere.text = text;
                touchSphere.linkInfo = linkInfo[i];
                touchSphere.link = HAND_LINKS[i];

                touchSphere.hoverOver = function () {

                    this.text.material.color = new THREE.Color(0xffffff);
                    this.hand.material.uniforms._HueSize.value = .2;
                    this.hand.material.uniforms._Lightness.value = 5;
                    this.hand.material.uniforms._Saturation.value = 1;
                }

                touchSphere.hoverOut = function () {
                    this.text.material.color = new THREE.Color(0xa0a0a0);
                    this.hand.material.uniforms._HueSize.value = .02;
                    this.hand.material.uniforms._Lightness.value = 2;
                    this.hand.material.uniforms._Saturation.value = 1;



                }

                touchSphere.select = function () {

                    //print("Setting position");
                    //print(this.hand.position);
                    clickLink(this.link, this.hand.position);
                }


                touchSphere.hoverOut();

                controls.add(touchSphere);

                text.add(touchSphere);


                cornerLinks[i] = hand;
                cornerLinks[i].text = text;

            }



            /*
            
             ___ ___  __ __   _____ ____     __      _      ____  ____   __  _   _____
            |   |   ||  |  | / ___/|    |   /  ]    | |    |    ||    \ |  |/ ] / ___/
            | _   _ ||  |  |(   \_  |  |   /  /     | |     |  | |  _  ||  ' / (   \_ 
            |  \_/  ||  |  | \__  | |  |  /  /      | |___  |  | |  |  ||    \  \__  |
            |   |   ||  :  | /  \ | |  | /   \_     |     | |  | |  |  ||     \ /  \ |
            |   |   ||     | \    | |  | \     |    |     | |  | |  |  ||  .  | \    |
            |___|___| \__,_|  \___||____| \____|    |_____||____||__|__||__|\_|  \___|
                 
            
            */

            var musicLinkInfo = [
                "ROCK",
                "FILM",
                "CLASSICAL",
                "MISC"
            ]


            var baseUniforms = {
                hueStart: .6,
                hueSize: .1,
                lightness: 4,
                noiseSpeed: .1,
                noiseSize: .1,
                noiseOffset: .2,
                saturation: 0,
            }

            var hoveredUniforms = {
                hueStart: .1,
                hueSize: .3,
                lightness: 101,
                noiseSpeed: .1,
                noiseSize: .1,
                noiseOffset: .2,
                saturation: 1,
            }


            var selectedUniforms = {
                hueStart: .1,
                hueSize: 1,
                lightness: 101,
                noiseSpeed: .1,
                noiseSize: .1,
                noiseOffset: .2,
                saturation: 1,
            }


            var geos = [
                models.words.misc.children[0].geometry,
                models.words.classical.children[0].geometry,
                models.words.film.children[0].geometry,
                models.words.rock.children[0].geometry,
            ]

            var hulls = [
                models.words.miscHull.children[0].geometry,
                models.words.classicalHull.children[0].geometry,
                models.words.filmHull.children[0].geometry,
                models.words.rockHull.children[0].geometry,
            ]

            var scales = [
                1,
                1,
                1,
                1,


            ]

            var linkInfo = [
                "MISC",
                "CLASSICAL",
                "FILM",
                "ROCK"
            ]

            var position = 8;
            var spread = 1;


            var current = 8;
            for (var i = 0; i < 4; i++) {
                //print("ML");
                //print(MUSIC_LINKS[i])
                var link = new SkullLink({
                    vertexShader: vs1,
                    fragmentShader: fs1,
                    geometry: geos[i],
                    shield: hulls[i],
                    linkInfo: linkInfo[i],
                    uniforms: uniforms,
                    hoveredUniforms: hoveredUniforms,
                    baseUniforms: baseUniforms,
                    selectedUniforms: selectedUniforms,
                    scale: .1 * scales[i],
                    controls: controls,
                    scene: scene,
                    clickLink: clickLink,
                    link: MUSIC_LINKS[i],
                })



                link.main.position.set(0, current, 0);

                current += scales[i] * spread;
            }




            /*


                    ___ ___   ____  ____  ____        _____ __  _  __ __  _      _     
                    |   |   | /    ||    ||    \      / ___/|  |/ ]|  |  || |    | |    
                    | _   _ ||  o  | |  | |  _  |    (   \_ |  ' / |  |  || |    | |    
                    |  \_/  ||     | |  | |  |  |     \__  ||    \ |  |  || |___ | |___ 
                    |   |   ||  _  | |  | |  |  |     /  \ ||     \|  :  ||     ||     |
                    |   |   ||  |  | |  | |  |  |     \    ||  .  ||     ||     ||     |
                    |___|___||__|__||____||__|__|      \___||__|\_| \__,_||_____||_____|
                
                    Skull

            */


            var skullMaterial = new THREE.ShaderMaterial({
                uniforms: {

                    dT: uniforms.dT,
                    time: uniforms.time,
                    lightPos: uniforms.lightPos,
                    t_matcap: uniforms.t_matcap,
                    t_normal: uniforms.t_normal,

                    t_audio: uniforms.t_audio,
                    t_colormap: uniforms.t_colormap,

                    _NoiseSize: { type: "f", value: 1 },
                    _NoiseSpeed: { type: "f", value: .3 },
                    _NoiseOffset: { type: "f", value: .3 },
                    _HueStart: { type: "f", value: .9 },
                    _HueSize: { type: "f", value: .04 },
                    _NormalDepth: { type: "f", value: .1 },
                    _FFTStart: { type: "f", value: .1 },
                    _FFTSize: { type: "f", value: 2.1 },
                    _Saturation: { type: "f", value: .5 },
                    _Lightness: { type: "f", value: 1 },
                    _DiscardAmount: { type: "f", value: 0 }

                },
                vertexShader: vs1,
                fragmentShader: fs1,
                side: THREE.DoubleSide
            })

            skullMaterial.extensions.derivatives = true;

            //print(models.glbSkull);

            var skull = new THREE.Mesh(models.glbSkull.geometry, skullMaterial);


            var skullMaterial2 = new THREE.ShaderMaterial({
                uniforms: {

                    dT: uniforms.dT,
                    time: uniforms.time,
                    lightPos: uniforms.lightPos,
                    t_matcap: uniforms.t_matcap,
                    t_normal: uniforms.t_normal,

                    t_audio: uniforms.t_audio,
                    t_colormap: uniforms.t_colormap,

                    _NoiseSize: { type: "f", value: 1 },
                    _NoiseSpeed: { type: "f", value: .3 },
                    _NoiseOffset: { type: "f", value: .1 },
                    _HueStart: { type: "f", value: .6 },
                    _HueSize: { type: "f", value: 1 },
                    _NormalDepth: { type: "f", value: .1 },
                    _FFTStart: { type: "f", value: 1 },
                    _FFTSize: { type: "f", value: 3.1 },
                    _Saturation: { type: "f", value: 1 },
                    _Lightness: { type: "f", value: 10 },
                    _DiscardAmount: { type: "f", value: 0 }

                },
                vertexShader: vs1,
                fragmentShader: fs1,
                side: THREE.DoubleSide
            })

            skullMaterial2.extensions.derivatives = true;

            var skullWords = new THREE.Mesh(models.glbMusic.geometry, skullMaterial2);



            //print("HI");
            //print(models.skullShield.geometry);

            mainSkull = new THREE.Mesh(models.skullShield.geometry, new THREE.MeshBasicMaterial({
                color: 0xffffff,
                transparent: true,
                opacity: .0,
                depthWrite: false,
                side: THREE.DoubleSide
            }));
            mainSkull.scale.x = 11;
            mainSkull.scale.y = 11;
            mainSkull.scale.z = 11;
            mainSkull.position.y = 20;
            mainSkull.position.z = 20;

            //skull.rotation.x = Math.PI / 2;
            skull.scale.multiplyScalar(3.2);
            //    skull.position.y = 0;
            skull.position.z = -2;
            //skull.position.x = -.5;

            //skullWords.rotation.x = Math.PI / 2;
            skullWords.scale.multiplyScalar(3.2);
            skullWords.position.z = -1.5;
            skullWords.position.y = -1;
            //skullWords.position.z = -3;
            //skullWords.position.x = -.5;




            mainSkull.name = 'skullShield'
            mainSkull.add(skull);
            mainSkull.add(skullWords);

            mainSkull.mainSkull = skull;

            scene.add(mainSkull);
            controls.add(mainSkull);
            mainSkull.text = skullWords;



            var downTime;
            var upTime;
            var downPos;
            var upPos;



            var interactionUniforms = {

                skullNoiseOffset_base: .1,
                skullNoiseOffset_hovered: .11,
                skullNoiseOffset_selected: .21,

                skullHueSize_base: 3.1,
                skullHueSize_hovered: 5,
                skullHueSize_selected: 2.5,

                skullSaturation_base: .7,
                skullSaturation_hovered: .7,
                skullSaturation_selected: .6,


                skullLightness_base: 6,
                skullLightness_hovered: 3,
                skullLightness_selected: 5,


                wordNoiseOffset_base: .01,
                wordNoiseOffset_hovered: .03,
                wordNoiseOffset_selected: .01,

                wordHueSize_base: 11.1,
                wordHueSize_hovered: 11.3,
                wordHueSize_selected: .5,

                wordSaturation_base: .2,
                wordSaturation_hovered: .2,
                wordSaturation_selected: .2,


                wordLightness_base: 2,
                wordLightness_hovered: 5,
                wordLightness_selected: 5,



            }


            mainSkull.interactionUniforms = interactionUniforms;
            mainSkull.select = function () {
                //if (!mobileCheck()) {
                downTime = uniforms.time.value;
                downPos = controls.mouse.clone();

                this.mainSkull.material.uniforms._NoiseOffset.value = this.interactionUniforms.skullNoiseOffset_selected;
                this.mainSkull.material.uniforms._HueSize.value = this.interactionUniforms.skullHueSize_selected;
                this.mainSkull.material.uniforms._Saturation.value = this.interactionUniforms.skullSaturation_selected;
                this.mainSkull.material.uniforms._Lightness.value = this.interactionUniforms.skullLightness_selected;

                this.text.material.uniforms._NoiseOffset.value = this.interactionUniforms.wordNoiseOffset_selected;
                this.text.material.uniforms._HueSize.value = this.interactionUniforms.wordHueSize_selected;
                this.text.material.uniforms._Saturation.value = this.interactionUniforms.wordSaturation_selected;
                this.text.material.uniforms._Lightness.value = this.interactionUniforms.wordLightness_selected;
                // }
            }

            mainSkull.deselect = function () {

                // if (!mobileCheck()) {
                upTime = uniforms.time.value;
                upPos = controls.mouse.clone();
                if (upTime - downTime < .2 && upPos.sub(downPos).length() < .02) {
                    ToggleCameraPosition();
                }
                //}
            }



            mainSkull.hoverOver = function () {

                this.mainSkull.material.uniforms._NoiseOffset.value = this.interactionUniforms.skullNoiseOffset_hovered;
                this.mainSkull.material.uniforms._HueSize.value = this.interactionUniforms.skullHueSize_hovered;
                this.mainSkull.material.uniforms._Saturation.value = this.interactionUniforms.skullSaturation_hovered;
                this.mainSkull.material.uniforms._Lightness.value = this.interactionUniforms.skullLightness_hovered;


                this.text.material.uniforms._NoiseOffset.value = this.interactionUniforms.wordNoiseOffset_hovered;
                this.text.material.uniforms._HueSize.value = this.interactionUniforms.wordHueSize_hovered;
                this.text.material.uniforms._Saturation.value = this.interactionUniforms.wordSaturation_hovered;
                this.text.material.uniforms._Lightness.value = this.interactionUniforms.wordLightness_hovered;

                print("hiiii");
                ///if (mobileCheck()) {
                //    ToggleCameraPosition();
                //}
            }

            mainSkull.hoverOut = function () {
                this.text.material.color = new THREE.Color(0x00ff00);
                this.mainSkull.material.uniforms._NoiseOffset.value = this.interactionUniforms.skullNoiseOffset_base;
                this.mainSkull.material.uniforms._HueSize.value = this.interactionUniforms.skullHueSize_base;
                this.mainSkull.material.uniforms._Saturation.value = this.interactionUniforms.skullSaturation_base;
                this.mainSkull.material.uniforms._Lightness.value = this.interactionUniforms.skullLightness_base;


                this.text.material.uniforms._NoiseOffset.value = this.interactionUniforms.wordNoiseOffset_base;
                this.text.material.uniforms._HueSize.value = this.interactionUniforms.wordHueSize_base;
                this.text.material.uniforms._Saturation.value = this.interactionUniforms.wordSaturation_base;
                this.text.material.uniforms._Lightness.value = this.interactionUniforms.wordLightness_base;
            }


            mainSkull.hoverOut();




            raycaster = new THREE.Raycaster();

            renderer = new THREE.WebGLRenderer();
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.setSize(window.innerWidth, window.innerHeight);
            container.appendChild(renderer.domElement);

            stats = new Stats();
            // container.appendChild(stats.dom);

            document.addEventListener('mousemove', onPointerMove);


            //

            window.addEventListener('resize', onWindowResize);


            /*
            
            
             .----------------.  .----------------.  .-----------------. .----------------.  .----------------. 
            | .--------------. || .--------------. || .--------------. || .--------------. || .--------------. |
            | |  _______     | || |     _____    | || | ____  _____  | || |    ______    | || |    _______   | |
            | | |_   __ \    | || |    |_   _|   | || ||_   \|_   _| | || |  .' ___  |   | || |   /  ___  |  | |
            | |   | |__) |   | || |      | |     | || |  |   \ | |   | || | / .'   \_|   | || |  |  (__ \_|  | |
            | |   |  __ /    | || |      | |     | || |  | |\ \| |   | || | | |    ____  | || |   '.___`-.   | |
            | |  _| |  \ \_  | || |     _| |_    | || | _| |_\   |_  | || | \ `.___]  _| | || |  |`\____) |  | |
            | | |____| |___| | || |    |_____|   | || ||_____|\____| | || |  `._____.'   | || |  |_______.'  | |
            | |              | || |              | || |              | || |              | || |              | |
            | '--------------' || '--------------' || '--------------' || '--------------' || '--------------' |
             '----------------'  '----------------'  '----------------'  '----------------'  '----------------' 
            
            
            */



            rings = new THREE.Object3D();

            rings.rings = []

            var ringT = [
                textures.ring2,
            ]

            var ringScales = [
                600,
            ]

            var zPos = [
                200,
            ]

            for (var i = 0; i < 2; i++) {

                var mat = new THREE.ShaderMaterial({
                    transparent: true,
                    blending: THREE.AdditiveBlending,
                    // map: ringT[i],
                    alphaTest: .05,
                    depthWrite: false,
                    //   opacity: .6,
                    //  color: 0xff0000,
                    side: THREE.DoubleSide,
                    vertexShader: vs2,
                    fragmentShader: fs3,
                    uniforms: {
                        _MainTex: {
                            type: "t", value: ringT[i]
                        },
                        t_colormap: uniforms.t_colormap,
                        time: uniforms.time
                    }
                });

                var geo = new THREE.PlaneGeometry(1, 1, 1, 1);

                var mesh = new THREE.Mesh(geo, mat);


                mesh.scale.multiplyScalar(ringScales[i]);
                mesh.position.z = -zPos[i];

                rings.add(mesh);
                rings.rings[i] = mesh;
                rings.rings[i].zPos = zPos[i];



            }

            scene.add(rings);







            /*
 _       ___    ___   ____    _____
| |     /   \  /   \ |    \  / ___/
| |    |     ||     ||  o  )(   \_ 
| |___ |  O  ||  O  ||   _/  \__  |
|     ||     ||     ||  |    /  \ |
|     ||     ||     ||  |    \    |
|_____| \___/  \___/ |__|     \___|
                                   
*/
            for (let key in audioSamples) {
                //console.log("made");
                audio.samples[key] = (new BufferedAudio(audioSamples[key], audio.ctx, audio.gain));
            }
            /*
                        var mesh = new THREE.Mesh(
                            models.eyeball.children[0].geometry,
                            new THREE.MeshBasicMaterial({
                                map: textures.eyeball,
                                side: THREE.DoubleSide
                            })
            
                        );
            
                        mesh.scale.multiplyScalar(1000);*/
            // scene.add(mesh);


            var brightness = [
                10,
                3,
                .8,
                .6,
                .3,
                2,
                2,
            ]

            var scales = [
                1,
                1,
                1,
                1,
                1,
                1,
                1
            ]


            var special = [
                0,
                0,
                0,
                0,
                0,
                1,
                0
            ]

            for (var i = 0; i < 7; i++) {


                var p = new THREE.Vector3();

                audioLoopObjects[i] = new AudioLoop(new BufferedAudio(stems[i], audio.ctx, audio.gain), i / 7, {
                    scene: scene,
                    controls: controls,
                    audio: audio,
                    uniforms: uniforms,
                    vertex: vs1,
                    fragment: fs2,
                    map: textures.ring1,
                    geometry: models.eyeball.children[0].geometry.clone(),
                    texture: textures.eyeball,
                    position: p,
                    brightness: brightness[i],
                    scale: scales[i],
                    special: special[i]
                });


                scene.add(audioLoopObjects[i]);

            }

            looper = new Looper(audio, uniforms, {

                beatsPerMinute: 82.5,
                beatsPerMeasure: 4,
                beatType: 4,
                measuresPerLoop: 10

            });



            looper.everyLoop(function () {
                for (var i = 0; i < 7; i++) {
                    audioLoopObjects[i].loop.play();
                }

            })

            looper.start();





            /*

            
 ____    ____  ____   ______  ____     __  _        ___   _____
|    \  /    ||    \ |      ||    |   /  ]| |      /  _] / ___/
|  o  )|  o  ||  D  )|      | |  |   /  / | |     /  [_ (   \_ 
|   _/ |     ||    / |_|  |_| |  |  /  /  | |___ |    _] \__  |
|  |   |  _  ||    \   |  |   |  | /   \_ |     ||   [_  /  \ |
|  |   |  |  ||  .  \  |  |   |  | \     ||     ||     | \    |
|__|   |__|__||__|\_|  |__|  |____| \____||_____||_____|  \___|
            


            */

            const radius = 300;

            var geometry1 = new THREE.BufferGeometry();

            const positions = [];
            const colors = [];
            const sizes = [];

            const color = new THREE.Color();
            var particles = 1000;

            for (let i = 0; i < particles; i++) {

                positions.push((Math.random() * 2 - 1) * radius);
                positions.push((Math.random() * 2 - 1) * radius);
                positions.push((Math.random() * 2 - 1) * radius);

                color.setHSL(i / particles, 1, .5);

                colors.push(color.r, color.g, color.b);

                sizes.push(1);

            }

            geometry1.setAttribute('position', new THREE.Float32BufferAttribute(positions, 3));
            geometry1.setAttribute('color', new THREE.Float32BufferAttribute(colors, 3));
            geometry1.setAttribute('size', new THREE.Float32BufferAttribute(sizes, 1).setUsage(THREE.DynamicDrawUsage));

            var particleSystem = new THREE.Points(geometry1, new THREE.PointsMaterial({ size: 4, vertexColors: true, blending: THREE.AdditiveBlending, transparent: true, depthWrite: false, map: textures.flare }));

            scene.add(particleSystem);

            unmute(audio.ctx, false, false)


        }



        /*

 __ __  ____   ___     ____  ______    ___ 
|  |  ||    \ |   \   /    ||      |  /  _]
|  |  ||  o  )|    \ |  o  ||      | /  [_ 
|  |  ||   _/ |  D  ||     ||_|  |_||    _]
|  :  ||  |   |     ||  _  |  |  |  |   [_ 
|     ||  |   |     ||  |  |  |  |  |     |
 \__,_||__|   |_____||__|__|  |__|  |_____|



        */

        var frame = 0;

        function animate() {


            frame += 1;
            if (frame < 10) {

                mainSkull.hoverOut();
            }
            requestAnimationFrame(animate);


            if (camControls.lerpingToTarget == false) {
                camControls.update();
            }

            audio.update();

            render();
            stats.update();

        }

        function render() {



            theta += 0.1;

            clock.deltaTime = clock.getDelta();
            uniforms.dT.value = clock.deltaTime;
            uniforms.time.value = clock.elapsedTime;

            looper._update();



            var angleSize = 1;
            var angleStart = 0.12;
            var corners = getPositionsAroundSkull(50.5, angleSize, angleStart, 0);
            var corners2 = getScreenCornersInWorld(camera, 160, .8);
            var cornerRotations = getRotationsAroundSkull(angleSize, angleStart);

            for (var i = 0; i < 4; i++) {
                cornerLinks[i].position.lerp(corners[i].lerp(corners2[i], Math.min(uniforms.time.value / 1, 1)), .1);//).set(corners[i].x, corners[i].y, corners[i].z);// = sphere;

                cornerLinks[i].quaternion.copy(cornerRotations[i]);//.slerp(cornerRotations[i], 1);
                cornerLinks[i].updateMatrixWorld();

                var dir1 = cornerLinks[i].position.clone().sub(camera.position).normalize();

                cornerLinks[i].text.position.copy(cornerLinks[i].position.clone().add(dir1.multiplyScalar(-30)));
                cornerLinks[i].text.rotation.copy(camera.rotation.clone());
                // cornerLinks[i].text.lookAt(camera.position);
            }





            var floatSize = 6;
            var floatSpeed = .3;
            for (var i = 0; i < audioLoopObjects.length; i++) {

                /* var xOffset = Math.sin(i * 10 + uniforms.time.value * floatSpeed * (2 + Math.sin(i * 30))) * floatSize;
                 var yOffset = Math.sin(i * 30 + uniforms.time.value * floatSpeed * (2 + Math.sin(i * 10))) * floatSize;
                 var zOffset = Math.sin(i * 60 + uniforms.time.value * floatSpeed * (2 + Math.sin(i * 20))) * floatSize * 2;
 
                   audioLoopObjects[i].position.copy(audioLoopObjects[i].originalPosition.clone().add(new THREE.Vector3(xOffset, yOffset, zOffset)));
 */
                /// print(audioLoopObjects[i].position);
                audioLoopObjects[i].update();
            }


            if (camControls.lerpingToTarget == true) {

                lerpToTarget();
            } else {


                camControls.target = camControls.target.lerp(camControls.lerpTarget, .1);
                var cLength = camera.position.clone().sub(camControls.target).length();
                var dir = camera.position.clone().sub(camControls.target).normalize();

                var nLength = lerp(cLength, camControls.desiredZoom, .1);

                dir.multiplyScalar(nLength)

                camera.position.copy(dir.add(camControls.target));
            }


            camera.getWorldDirection(tv1);
            //  print(camera.position);
            //tv1.multiplyScalar(0);


            //tv1.x = 0;
            //tv1.y = 0;
            //tv1.z = 0;
            //print(tv1)
            //rings.position.x = tv1.x * 100;
            //rings.position.y = tv1.y * 100;
            //rings.position.z = tv1.z * 100;

            tv1.normalize();


            for (var i = 0; i < rings.rings.length; i++) {



                tv2.set(
                    tv1.x * rings.rings[i].zPos,
                    tv1.y * rings.rings[i].zPos,
                    tv1.z * rings.rings[i].zPos
                )
                tv2.multiplyScalar(Math.sin(uniforms.time.value) * .1 + 1.1);
                rings.rings[i].position.lerp(tv2, .03);

                var q1 = new THREE.Quaternion().copy(rings.rings[i].quaternion);

                rings.rings[i].lookAt(camera.position.clone().add(new THREE.Vector3(Math.sin(uniforms.time.value * 1.2), Math.cos(uniforms.time.value * 1.4), Math.sin(uniforms.time.value * 1.311)).multiplyScalar(20)));
                var q2 = new THREE.Quaternion().copy(rings.rings[i].quaternion);

                rings.rings[i].quaternion.copy(q1);
                rings.rings[i].quaternion.slerp(q2, .03);//Math.sin(i + uniforms.time.value * .4) * .07);
            }
            //rings.lookAt(camera.position);

            renderer.render(scene, camera);

        }




        /*


        
 __ __  ______  ____  _       _____
|  T  T|      Tl    j| T     / ___/
|  |  ||      | |  T | |    (   \_ 
|  |  |l_j  l_j |  | | l___  \__  T
|  :  |  |  |   |  | |     T /  \ |
l     |  |  |   j  l |     | \    |
 \__,_j  l__j  |____jl_____j  \___j
        


        */
        function lerp(a, b, alpha) {
            return a + alpha * (b - a);
        }

        var frontText = document.getElementById("frontText");
        function clickLink(text, position) {

            window.location.href = text;
            // print(text);//
            //window.location.href = text;
            /*
            frontText.innerHTML = text;
            setUpTargetLerp(position, position, .5, function () {
                print("made it to the end");
            })

            print("It has happened");
            setTimeout(function () {
                frontText.innerHTML = "";
            }, 1000);*/
        }


        function ToggleCameraPosition() {
            var cc = camControls;
            if (cc.desiredZoom == farZoom) {
                cc.desiredZoom = closeZoom;
                cc.lerpTarget = new THREE.Vector3(0, 10, 0);
            } else {
                cc.desiredZoom = farZoom;
                cc.lerpTarget = new THREE.Vector3(0, 0, 0);
            }
        }


        function CornerLink(params) {

        }




        function getScreenCornersInWorld(camera, distance, size) {
            const topLeft = new THREE.Vector3(-size, size, -size);
            const topRight = new THREE.Vector3(size, size, -size);
            const bottomLeft = new THREE.Vector3(-size, -size, -size);
            const bottomRight = new THREE.Vector3(size, -size, -size);

            const corners = [topRight, topLeft, bottomLeft, bottomRight];

            return corners.map(corner => {
                return screenToWorld(camera, corner, distance);

            });
        }

        function screenToWorld(camera, position, depth) {
            var vector = position;
            vector.unproject(camera);
            var dir = vector.sub(camera.position).normalize();
            return camera.position.clone().add(dir.multiplyScalar(depth));
        }






        function getPositionsAroundSkull(size, angleSize, angleStart, yOffset) {

            var corners = [];
            for (var i = 0; i < 4; i++) {

                var n = i / 4;
                var a = (n * angleSize + angleStart) * 6.28;

                var x = Math.cos(a) * size;
                var y = Math.sin(a) * size;
                corners.push(new THREE.Vector3(x, y + yOffset, 0));
            }

            return corners;


        }


        function getRotationsAroundSkull(angleSize, angleStart) {

            var corners = [];
            for (var i = 0; i < 4; i++) {

                var n = i / 4;
                var a = (n * angleSize + angleStart) * 6.28;

                const quaternion = new THREE.Quaternion();
                quaternion.setFromEuler(new THREE.Euler(0, 0, a));
                quaternion.multiply(new THREE.Quaternion().setFromEuler(new THREE.Euler(Math.PI / 2, 0, 0)));

                corners.push(quaternion);
            }

            return corners;


        }

        function onWindowResize() {

            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();

            renderer.setSize(window.innerWidth, window.innerHeight);

        }

        function onPointerMove(event) {

            pointer.x = (event.clientX / window.innerWidth) * 2 - 1;
            pointer.y = - (event.clientY / window.innerHeight) * 2 + 1;

        }


        function setUpTargetLerp(target, lookTarget, speed, onFinishLerp) {
            /*camControls.lerpingToTarget = true;
            camControls.targetToLerpTo = target;
            camControls.lookTargetToLerpTo = lookTarget;
            camControls.lerpToStartTime = uniforms.time.value;
            camControls.lerpToSpeed = speed;
            camControls.lerpPositionStart = camera.position.clone();
            camControls.onFinishLerp = onFinishLerp;*/
        }

        function lerpToTarget() {

            /*  var v = (uniforms.time.value - camControls.lerpToStartTime) / camControls.lerpToSpeed;
  
              print(v);
  
              if (v > 1) {
                  v = 1;
                  camControls.lerpingToTarget = false;
              }
  
              print(camControls.targetToLerpTo);
              print(camControls.lerpPositionStart);
              var v2 = camControls.lerpPositionStart.clone().lerp(camControls.targetToLerpTo.clone(), v);
              print(v2);
              camera.position.set(v2);
  
              print(camera.position);
              //camera.lookAt(camControls.lookTargetToLerpTo);
  
              if (v >= 1) {
                  camControls.onFinishLerp();
  
              }
  */
        }



        document.addEventListener("visibilitychange", function () {
            if (document.hidden) {
                //console.log("Browser tab is hidden")
            } else {
                window.location.reload()
            }
        });

    </script>

</body>

</html>
