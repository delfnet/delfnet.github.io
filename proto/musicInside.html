<!DOCTYPE html>
<html lang="en">

<head>
    <title>three.js webgl - interactive cubes</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
    <link type="text/css" rel="stylesheet" href="main.css">
    <style>
        body {
            background-color: #f0f0f0;
            color: #444;

        }

        a {
            color: #08f;
        }

        #container {
            display: block;
            left: 0px;
            top: 0px;
        }

        #frontText {
            position: absolute;
            top: 0%;
            left: 50%;
            transform: translate(-50%, 60%);
            font-size: 50px;
            font-family: 'Courier New', Courier, monospace;
            color: #fff;
            text-align: center;
            z-index: 100;
        }

        #progress {
            position: absolute;
            height: 10px;
            top: 50%;
            margin-top: -5px;
            background: #F00;
        }

        #startButton {
            position: absolute;
            height: 20px;
            width: 100px;
            top: 50%;
            left: 50%;
            margin-left: -50px;
            margin-top: -10px;
            background: #FF0;
            text-align: center;
            vertical-align: middle;
            line-height: 20px;

        }

        #progressText {
            position: absolute;
            height: 20px;
            width: 100px;
            top: 50%;
            left: 50%;
            margin-left: -50px;
            margin-top: -10px;
            background: #FF0;
            text-align: center;
            vertical-align: middle;
            line-height: 20px;

        }
    </style>
</head>

<body>


    <div id="frontText"></div>
    <div id="load">
        <div id="progress"></div>
        <div id="progressText">Loading...</div>
        <a id="startButton" style="display:none">ENTER</a>
    </div>

    <!-- Import maps polyfill -->
    <!-- Remove this when import maps will be widely supported -->
    <script async src="https://unpkg.com/es-module-shims@1.6.3/dist/es-module-shims.js"></script>

    <script type="importmap">
			{
				"imports": {
					"three": "./lib/three.module.js",
					"three/addons/": "./lib/"
				}
			}
	</script>



    <script type="module">

        var lib = './lib/';

        import * as THREE from 'three';

        import $ from "./lib/jquery.module.js";

        import Stats from './lib/stats.module.js';
        import ObjectControls from './lib/ObjectControls.js'
        import AudioBuffer from './lib/AudioBuffer.js'
        import AudioController from './lib/AudioController.js'
        import BufferedAudio from './lib/BufferedAudio.js'
        import { OBJLoader } from './lib/OBJLoader.js';
        import MouseMoveControls from './lib/MouseMoveControls.js'
        import TextCreator from './lib/TextCreator.js'
        import { OrbitControls } from './lib/OrbitControls.js'

        import Looper from './lib/Looper.js'



        import vs1 from './shaders/vs-trace.js'
        import fs1 from './shaders/fs-trace.js'

        // override cuz im useless
        print = console.log;

        let clickCutoff = 100;

        let container, stats;
        let camera, scene, raycaster, renderer;

        let audio;

        let tv1 = new THREE.Vector3();
        let tv2 = new THREE.Vector3();
        let looper;

        let INTERSECTED;
        let theta = 0;

        const pointer = new THREE.Vector2();
        const radius = 100;
        let controls;
        var camControls;
        let clock = new THREE.Clock();

        clock.deltaTime = 0;




        let manager = new THREE.LoadingManager();

        // get element by id
        var progress = document.getElementById('progress');
        var progressText = document.getElementById('progressText');
        var startButton = document.getElementById('startButton');
        var loadDiv = document.getElementById('load');


        startButton.onclick = function () {
            progress.display = 'none';
            progressText.display = 'none';
            loadDiv.style.display = 'none';
            init();
            audio.ctx.resume();
            animate();
        }

        manager.onProgress = function (url, itemsLoaded, itemsTotal) {
            progress.style.width = (itemsLoaded / itemsTotal * 100) + '%';
            console.log(url);
            console.log("PROGGERS  :" + (itemsLoaded / itemsTotal * 100) + '%');
        };

        manager.onLoad = function () {

            console.log("lads");
            startButton.style.display = 'block';
            progressText.style.display = 'none';
            loadDiv.style.display = 'block';
            //init();
            //audio.ctx.resume();
            //animate();

        }



        // instantiate a loader
        const audioLoader = new THREE.AudioLoader(manager);
        const textureLoader = new THREE.TextureLoader(manager);
        const objLoader = new OBJLoader(manager);



        const audioSamples = {}
        const stems = [];

        const textures = {}
        const models = {}

        models.words = {}
        const audioLoopObjects = [];


        /*


        
 _       ___    ____  ___   
| |     /   \  /    ||   \  
| |    |     ||  o  ||    \ 
| |___ |  O  ||     ||  D  |
|     ||     ||  _  ||     |
|     ||     ||  |  ||     |
|_____| \___/ |__|__||_____|
        
*/

        function load() {

            audioLoader.load('./audio/01 Melodic Enter.wav', function (buffer) {
                console.log("loaded audio");
                audioSamples.enter1 = buffer;
            });


            audioLoader.load('./audio/stems/stem 1_bassoon_bells_bass.wav', function (buffer) {
                console.log("loaded audio");
                audioSamples.stem1 = buffer;
                stems[0] = buffer;
            });

            audioLoader.load('./audio/stems/stem 2_short strings.wav', function (buffer) {
                console.log("loaded audio");
                audioSamples.stem2 = buffer;
                stems[1] = buffer;
            });


            audioLoader.load('./audio/stems/stem 3_low strings.wav', function (buffer) {
                console.log("loaded audio");
                audioSamples.stem3 = buffer;
                stems[2] = buffer;
            });


            audioLoader.load('./audio/stems/stem 4_rhythm section.wav', function (buffer) {
                console.log("loaded audio");
                audioSamples.stem4 = buffer;
                stems[3] = buffer;
            });


            audioLoader.load('./audio/stems/stem 5_ guit 1.wav', function (buffer) {
                console.log("loaded audio");
                audioSamples.stem5 = buffer;
                stems[4] = buffer;
            });

            audioLoader.load('./audio/stems/stem 6_guit 2.wav', function (buffer) {
                console.log("loaded audio");
                audioSamples.stem6 = buffer;
                stems[5] = buffer;
            });


            audioLoader.load('./audio/stems/stem 7 _guit 3.wav', function (buffer) {
                console.log("loaded audio");
                audioSamples.stem7 = buffer;
                stems[6] = buffer;
            });



            textureLoader.load('./img/rough-aluminium.jpg', function (texture) {
                textures.matcap = texture;
            });

            textureLoader.load('./img/flare.png', function (texture) {
                textures.flare = texture;
            });

            textureLoader.load('./img/t_n_snakeSkin.png', function (texture) {
                texture.wrapS = THREE.RepeatWrapping;
                texture.wrapT = THREE.RepeatWrapping;
                textures.normal = texture;
            });

            objLoader.load('./models/handClean1.obj', function (object) {
                models.hand = object;
            });


            objLoader.load('./models/testSkullSplit/fullSkull.obj', function (object) {
                models.skull = object;
            });


            objLoader.load('./models/wordModels/lowres/classical01_lowres.obj', function (object) {
                models.words.classical = object;
            });

            objLoader.load('./models/wordModels/convexhull/classical_hull.obj', function (object) {
                models.words.classicalHull = object;
            });

            objLoader.load('./models/wordModels/lowres/rock06_lowres.obj', function (object) {
                models.words.rock = object;
            });

            objLoader.load('./models/wordModels/convexhull/rock_hull.obj', function (object) {
                models.words.rockHull = object;
            });


            objLoader.load('./models/wordModels/lowres/film02_lowres.obj', function (object) {
                models.words.film = object;
            });

            objLoader.load('./models/wordModels/convexhull/film_hull.obj', function (object) {
                models.words.filmHull = object;
            });


            objLoader.load('./models/wordModels/lowres/misc02_lowres.obj', function (object) {
                models.words.misc = object;
            });

            objLoader.load('./models/wordModels/convexhull/misc_hull.obj', function (object) {
                models.words.miscHull = object;
            });


            objLoader.load('./models/wordModels/lowres/music04_lowres.obj', function (object) {
                models.words.music = object;
            });

            objLoader.load('./models/wordModels/convexhull/music_hull.obj', function (object) {
                models.words.musicHull = object;
            });






        }






        load();


        var cornerLinks = [];
        var musicCornerLinks = [];


        var uniforms = {

            dT: { type: "f", value: 0 },
            time: { type: "f", value: 0 },
            lightPos: { type: "v3", value: null },
            t_matcap: { type: "t", value: textures.matcap },
            t_normal: { type: "t", value: textures.normal },
            t_audio: { type: "t", value: null },

        }



        function init() {


            audio = new AudioController();
            audio.samples = {};
            uniforms.t_audio.value = audio.texture;


            uniforms.t_matcap.value = textures.matcap;
            uniforms.t_normal.value = textures.normal;


            container = document.createElement('div');
            container.id = 'container';
            document.body.appendChild(container);

            camera = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 1, 10000);

            controls = new ObjectControls(camera);

            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x000);

            camControls = new OrbitControls(camera, container);
            camControls.maxZoom = 10;
            camControls.desiredZoom = 140;
            camControls.enableDamping = true;
            camControls.enablePan = false;
            camControls.enableZoom = true;
            camControls.dampingFactor = .04;


            camera.position.set(0, 0, 140);

            clock = new THREE.Clock();
            clock.start();



            const geometry = new THREE.BoxGeometry(20, 20, 20);

            /*
            
                __   ___   ____   ____     ___  ____       _      ____  ____   __  _   _____
               /  ] /   \ |    \ |    \   /  _]|    \     | |    |    ||    \ |  |/ ] / ___/
              /  / |     ||  D  )|  _  | /  [_ |  D  )    | |     |  | |  _  ||  ' / (   \_ 
             /  /  |  O  ||    / |  |  ||    _]|    /     | |___  |  | |  |  ||    \  \__  |
            /   \_ |     ||    \ |  |  ||   [_ |    \     |     | |  | |  |  ||     \ /  \ |
            \     ||     ||  .  \|  |  ||     ||  .  \    |     | |  | |  |  ||  .  | \    |
             \____| \___/ |__|\_||__|__||_____||__|\_|    |_____||____||__|__||__|\_|  \___|
            
            
            
            */

            var corners = getScreenCornersInWorld(camera, 100, 1);

            console.log(models.hand.children[0].geometry);

            var handMaterial = new THREE.ShaderMaterial({
                uniforms: {

                    dT: uniforms.dT,
                    time: uniforms.time,
                    lightPos: uniforms.lightPos,
                    t_matcap: uniforms.t_matcap,
                    t_normal: uniforms.t_normal,
                    t_audio: uniforms.t_audio,

                    _NoiseSize: { type: "f", value: .05 },
                    _NoiseSpeed: { type: "f", value: .3 },
                    _NoiseOffset: { type: "f", value: 1.4 },
                    _HueStart: { type: "f", value: .4 },
                    _HueSize: { type: "f", value: .03 },
                    _NormalDepth: { type: "f", value: .1 },
                    _FFTStart: { type: "f", value: .1 },
                    _FFTSize: { type: "f", value: 1.1 },
                    _Saturation: { type: "f", value: 1 },
                    _Lightness: { type: "f", value: 2 },
                    _DiscardAmount: { type: "f", value: 1 }

                },
                vertexShader: vs1,
                fragmentShader: fs1,
                side: THREE.DoubleSide
            })

            handMaterial.extensions.derivatives = true;

            var linkInfo = [
                "MERCH",
                "BIO",
                "ABOUT",
                "PHOTOS"
            ]

            var textCreator = new TextCreator(10);


            var transparentMaterial = new THREE.MeshBasicMaterial({
                transparent: true,
                opacity: 0,
                depthWrite: false,
            });

            var angleSize = 1;
            var angleStart = 0.12;
            var corners = getPositionsAroundSkull(50.5, angleSize, angleStart, 0);

            var cornerRotations = getRotationsAroundSkull(angleSize, angleStart);




            for (var i = 0; i < 4; i++) {


                var text = textCreator.createMesh(linkInfo[i]);
                text.position.set(0, 0, 0);
                text.position.set(corners[i].x, corners[i].y, corners[i].z);
                scene.add(text);
                var hand = new THREE.Mesh(models.hand.children[0].geometry, handMaterial);
                console.log(corners[i]);


                hand.scale.x = 2;
                hand.scale.y = 2;
                hand.scale.z = 2;

                hand.position.set(corners[i].x, corners[i].y, corners[i].z);

                text.hand = hand;
                //controls.add(hand);

                scene.add(text);
                scene.add(hand);


                var touchSphere = new THREE.Mesh(new THREE.IcosahedronGeometry(1.8, 2), transparentMaterial);
                touchSphere.hand = hand;
                touchSphere.text = text;
                touchSphere.linkInfo = linkInfo[i];

                touchSphere.hoverOver = function () {

                    this.text.material.color = new THREE.Color(0x0000ff);
                }

                touchSphere.hoverOut = function () {
                    this.text.material.color = new THREE.Color(0x00ff00);


                }

                touchSphere.select = function () {

                    clickLink(this.linkInfo);
                }

                controls.add(touchSphere);

                text.add(touchSphere);


                cornerLinks[i] = hand;
                cornerLinks[i].text = text;

            }



            /*
            
             ___ ___  __ __   _____ ____     __      _      ____  ____   __  _   _____
            |   |   ||  |  | / ___/|    |   /  ]    | |    |    ||    \ |  |/ ] / ___/
            | _   _ ||  |  |(   \_  |  |   /  /     | |     |  | |  _  ||  ' / (   \_ 
            |  \_/  ||  |  | \__  | |  |  /  /      | |___  |  | |  |  ||    \  \__  |
            |   |   ||  :  | /  \ | |  | /   \_     |     | |  | |  |  ||     \ /  \ |
            |   |   ||     | \    | |  | \     |    |     | |  | |  |  ||  .  | \    |
            |___|___| \__,_|  \___||____| \____|    |_____||____||__|__||__|\_|  \___|
                 
            
            */

            var musicLinkInfo = [
                "ROCK",
                "CLASSICAL",
                "FILM",
                "MISC"
            ]
            var handMaterial = new THREE.ShaderMaterial({
                uniforms: {

                    dT: uniforms.dT,
                    time: uniforms.time,
                    lightPos: uniforms.lightPos,
                    t_matcap: uniforms.t_matcap,
                    t_normal: uniforms.t_normal,

                    t_audio: uniforms.t_audio,
                    _NoiseSize: { type: "f", value: 5.1 },
                    _NoiseSpeed: { type: "f", value: .2 },
                    _NoiseOffset: { type: "f", value: .03 },
                    _HueStart: { type: "f", value: .8 },
                    _HueSize: { type: "f", value: .05 },
                    _NormalDepth: { type: "f", value: .1 },
                    _FFTStart: { type: "f", value: .1 },
                    _FFTSize: { type: "f", value: 1 },
                    _Saturation: { type: "f", value: 1 },
                    _Lightness: { type: "f", value: 1 },
                    _DiscardAmount: { type: "f", value: 0 }

                },
                vertexShader: vs1,
                fragmentShader: fs1,
                side: THREE.DoubleSide
            })




            var classicalLink = new SkullLink({
                vertexShader: vs1,
                fragmentShader: fs1,
                geometry: models.words.classical.children[0].geometry,
                shield: models.words.classicalHull.children[0].geometry,
                uniforms: uniforms,
                linkInfo: "CLASSICAL",
                scale: 2,
                controls: controls,
                scene: scene
            })

            classicalLink.main.position.set(20, 0, 50);
            classicalLink.main.rotation.set(0, 0, -70);



            var rockLink = new SkullLink({
                vertexShader: vs1,
                fragmentShader: fs1,
                geometry: models.words.rock.children[0].geometry,
                shield: models.words.rockHull.children[0].geometry,
                uniforms: uniforms,
                linkInfo: "ROCK",
                scale: 2,
                controls: controls,
                scene: scene
            })

            rockLink.main.position.set(-20, -30, 50);
            rockLink.main.rotation.set(0, 0, 70);


            var miscLink = new SkullLink({
                vertexShader: vs1,
                fragmentShader: fs1,
                geometry: models.words.misc.children[0].geometry,
                shield: models.words.miscHull.children[0].geometry,
                uniforms: uniforms,
                linkInfo: "misc",
                scale: 2,
                controls: controls,
                scene: scene
            })

            miscLink.main.position.set(0, -50, 50);
            miscLink.main.rotation.set(0, 0, 30);

            var filmLink = new SkullLink({
                vertexShader: vs1,
                fragmentShader: fs1,
                geometry: models.words.film.children[0].geometry,
                shield: models.words.filmHull.children[0].geometry,
                uniforms: uniforms,
                linkInfo: "film",
                scale: 2,
                controls: controls,
                scene: scene
            })

            filmLink.main.position.set(-20, 30, 50);
            filmLink.main.rotation.set(0, 0, -50);







            var geo = new THREE.IcosahedronGeometry(1, 4);

            for (var i = 0; i < 4; i++) {


                var text = textCreator.createMesh(musicLinkInfo[i]);
                text.position.set(0, 0, 0);
                text.scale.x = 1.2;
                text.scale.y = 1.2;
                text.scale.z = 1.2;
                text.rotation.z = (Math.random() - .5);

                //text.position.set(corners[i].x, corners[i].y, corners[i].z);
                scene.add(text);
                var hand = new THREE.Mesh(geo, handMaterial);
                console.log(corners[i]);
                //sphere.position.set(corners[i].x, corners[i].y, corners[i].z);


                hand.scale.x = .3;
                hand.scale.y = .3;
                hand.scale.z = .3;
                hand.position.z = 0;

                text.hand = hand;
                //controls.add(hand);

                scene.add(text);
                scene.add(hand);


                var touchSphere = new THREE.Mesh(new THREE.IcosahedronGeometry(1.8, 2), transparentMaterial);
                touchSphere.hand = hand;
                touchSphere.text = text;
                touchSphere.linkInfo = musicLinkInfo[i];

                touchSphere.hoverOver = function () {
                    this.text.material.color = new THREE.Color(0x0000ff);
                }

                touchSphere.hoverOut = function () {
                    this.text.material.color = new THREE.Color(0x00ff00);
                }

                touchSphere.select = function () {

                    clickLink(this.linkInfo);
                }

                controls.add(touchSphere);

                text.add(touchSphere);


                musicCornerLinks[i] = hand;
                musicCornerLinks[i].text = text;

            }








            var handMaterial = new THREE.ShaderMaterial({
                uniforms: {

                    dT: uniforms.dT,
                    time: uniforms.time,
                    lightPos: uniforms.lightPos,
                    t_matcap: uniforms.t_matcap,
                    t_normal: uniforms.t_normal,

                    t_audio: uniforms.t_audio,
                    _NoiseSize: { type: "f", value: .1 },
                    _NoiseSpeed: { type: "f", value: 1.5 },
                    _NoiseOffset: { type: "f", value: 1.3 },
                    _HueStart: { type: "f", value: .3 },
                    _HueSize: { type: "f", value: .01 },
                    _NormalDepth: { type: "f", value: .1 },
                    _FFTStart: { type: "f", value: .1 },
                    _FFTSize: { type: "f", value: 1 },
                    _Saturation: { type: "f", value: 1.7 },
                    _Lightness: { type: "f", value: 1 },
                    _DiscardAmount: { type: "f", value: 0 }

                },
                vertexShader: vs1,
                fragmentShader: fs1,
                side: THREE.DoubleSide
            })

            handMaterial.extensions.derivatives = true;




            /*


                    ___ ___   ____  ____  ____        _____ __  _  __ __  _      _     
                    |   |   | /    ||    ||    \      / ___/|  |/ ]|  |  || |    | |    
                    | _   _ ||  o  | |  | |  _  |    (   \_ |  ' / |  |  || |    | |    
                    |  \_/  ||     | |  | |  |  |     \__  ||    \ |  |  || |___ | |___ 
                    |   |   ||  _  | |  | |  |  |     /  \ ||     \|  :  ||     ||     |
                    |   |   ||  |  | |  | |  |  |     \    ||  .  ||     ||     ||     |
                    |___|___||__|__||____||__|__|      \___||__|\_| \__,_||_____||_____|
                
                    Skull

            */


            var musicText = textCreator.createMesh("MUSIC");

            musicText.position.set(0, 25, 45);
            musicText.scale.x = 20.3;
            musicText.scale.y = 20.3;
            musicText.scale.z = 20.3;


            //musicText.position.set(corners[i].x, corners[i].y, corners[i].z);
            scene.add(musicText);

            var skullMaterial = new THREE.ShaderMaterial({
                uniforms: {

                    dT: uniforms.dT,
                    time: uniforms.time,
                    lightPos: uniforms.lightPos,
                    t_matcap: uniforms.t_matcap,
                    t_normal: uniforms.t_normal,

                    t_audio: uniforms.t_audio,

                    _NoiseSize: { type: "f", value: .05 },
                    _NoiseSpeed: { type: "f", value: .3 },
                    _NoiseOffset: { type: "f", value: 2 },
                    _HueStart: { type: "f", value: .1 },
                    _HueSize: { type: "f", value: .02 },
                    _NormalDepth: { type: "f", value: .1 },
                    _FFTStart: { type: "f", value: .1 },
                    _FFTSize: { type: "f", value: 2.1 },
                    _Saturation: { type: "f", value: 1 },
                    _Lightness: { type: "f", value: 4 },
                    _DiscardAmount: { type: "f", value: 0 }

                },
                vertexShader: vs1,
                fragmentShader: fs1,
                side: THREE.DoubleSide
            })

            skullMaterial.extensions.derivatives = true;


            var sphere = new THREE.Mesh(models.skull.children[0].geometry, skullMaterial);
            sphere.scale.x = 3;
            sphere.scale.y = 3;
            sphere.scale.z = 3;
            sphere.position.y = -5;
            sphere.position.z = -10;
            scene.add(sphere);
            controls.add(sphere);
            sphere.text = musicText;

            sphere.hoverOver = function () { }

            sphere.hoverOut = function () { }

            sphere.down = function () {
                print("down");
                downTime = uniforms.time.value;
            }

            var downTime;
            var upTime;
            sphere.up = function () {
                upTime = uniforms.time.value;
                print(upTime - downTime);
                if (upTime - downTime < .5) {
                    ToggleCameraPosition();
                }
            }

            sphere.select = function () {
                print("down");
                downTime = uniforms.time.value;
                //audio.samples['enter1'].play();
                // ToggleCameraPosition();
            }
            sphere.deselect = function () {
                upTime = uniforms.time.value;
                print(upTime - downTime);
                if (upTime - downTime < .15) {
                    ToggleCameraPosition();
                }
            }

            sphere.update = function () {
                console.log("updating");
            }



            sphere.hoverOver = function () {
                this.text.material.color = new THREE.Color(0x0000ff);
            }

            sphere.hoverOut = function () {
                this.text.material.color = new THREE.Color(0x00ff00);
            }





            raycaster = new THREE.Raycaster();

            renderer = new THREE.WebGLRenderer();
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.setSize(window.innerWidth, window.innerHeight);
            container.appendChild(renderer.domElement);

            stats = new Stats();
            // container.appendChild(stats.dom);

            document.addEventListener('mousemove', onPointerMove);

            //

            window.addEventListener('resize', onWindowResize);





            /*var geo = new THREE.PlaneBufferGeometry(100, 100);
            var mat = new THREE.MeshBasicMaterial({ color: 0xffffff, side: THREE.DoubleSide, map: uniforms.t_audio.value });

            var plane = new THREE.Mesh(geo, mat);

            scene.add(plane);*/

            /*
 _       ___    ___   ____    _____
| |     /   \  /   \ |    \  / ___/
| |    |     ||     ||  o  )(   \_ 
| |___ |  O  ||  O  ||   _/  \__  |
|     ||     ||     ||  |    /  \ |
|     ||     ||     ||  |    \    |
|_____| \___/  \___/ |__|     \___|
                                   
*/
            for (let key in audioSamples) {
                console.log("made");
                audio.samples[key] = (new BufferedAudio(audioSamples[key], audio.ctx, audio.gain));
            }



            for (var i = 0; i < 7; i++) {

                var v = i / 7;
                v *= Math.PI * 2;

                var x = Math.cos(v) * 40;
                var y = -Math.sin(v) * 40;

                audioLoopObjects[i] = new AudioLoop(new BufferedAudio(stems[i], audio.ctx, audio.gain), i / 7);
                audioLoopObjects[i].position.x = x;
                audioLoopObjects[i].position.y = 45;
                audioLoopObjects[i].position.z = y;//(Math.random() - .5) * 1 + 1;


                audioLoopObjects[i].scale.x = 10.2;
                audioLoopObjects[i].scale.y = 10.2;
                audioLoopObjects[i].scale.z = 10.2;
                audioLoopObjects[i].loop.gainNode.gain.setValueAtTime(0, audio.ctx.currentTime);
                scene.add(audioLoopObjects[i]);

            }

            looper = new Looper(audio, uniforms, {

                beatsPerMinute: 82.5,
                beatsPerMeasure: 4,
                beatType: 4,
                measuresPerLoop: 10

            });



            looper.everyLoop(function () {
                for (var i = 0; i < 7; i++) {
                    audioLoopObjects[i].loop.play();
                }

            })

            looper.start();





            /*

            
 ____    ____  ____   ______  ____     __  _        ___   _____
|    \  /    ||    \ |      ||    |   /  ]| |      /  _] / ___/
|  o  )|  o  ||  D  )|      | |  |   /  / | |     /  [_ (   \_ 
|   _/ |     ||    / |_|  |_| |  |  /  /  | |___ |    _] \__  |
|  |   |  _  ||    \   |  |   |  | /   \_ |     ||   [_  /  \ |
|  |   |  |  ||  .  \  |  |   |  | \     ||     ||     | \    |
|__|   |__|__||__|\_|  |__|  |____| \____||_____||_____|  \___|
            


            */

            const radius = 200;

            var geometry1 = new THREE.BufferGeometry();

            const positions = [];
            const colors = [];
            const sizes = [];

            const color = new THREE.Color();
            var particles = 1000;

            for (let i = 0; i < particles; i++) {

                positions.push((Math.random() * 2 - 1) * radius);
                positions.push((Math.random() * 2 - 1) * radius);
                positions.push((Math.random() * 2 - 1) * radius);

                color.setHSL(i / particles, .4, .5);

                colors.push(color.r, color.g, color.b);

                sizes.push(1);

            }

            geometry1.setAttribute('position', new THREE.Float32BufferAttribute(positions, 3));
            geometry1.setAttribute('color', new THREE.Float32BufferAttribute(colors, 3));
            geometry1.setAttribute('size', new THREE.Float32BufferAttribute(sizes, 1).setUsage(THREE.DynamicDrawUsage));

            var particleSystem = new THREE.Points(geometry1, new THREE.PointsMaterial({ size: 4, vertexColors: true, blending: THREE.AdditiveBlending, transparent: true, depthWrite: false, map: textures.flare }));

            scene.add(particleSystem);


        }


        function getScreenCornersInWorld(camera, distance, size) {
            const topLeft = new THREE.Vector3(-size, size, -size);
            const topRight = new THREE.Vector3(size, size, -size);
            const bottomLeft = new THREE.Vector3(-size, -size, -size);
            const bottomRight = new THREE.Vector3(size, -size, -size);

            const corners = [topRight, topLeft, bottomLeft, bottomRight];

            return corners.map(corner => {
                corner.unproject(camera);
                const direction = corner.sub(camera.position).normalize();
                return camera.position.clone().add(direction.multiplyScalar(distance));
            });
        }


        /*

 __ __  ____   ___     ____  ______    ___ 
|  |  ||    \ |   \   /    ||      |  /  _]
|  |  ||  o  )|    \ |  o  ||      | /  [_ 
|  |  ||   _/ |  D  ||     ||_|  |_||    _]
|  :  ||  |   |     ||  _  |  |  |  |   [_ 
|     ||  |   |     ||  |  |  |  |  |     |
 \__,_||__|   |_____||__|__|  |__|  |_____|



        */

        function animate() {

            requestAnimationFrame(animate);

            camControls.update();
            controls.update();
            audio.update();

            render();
            stats.update();

        }

        function render() {



            theta += 0.1;

            clock.deltaTime = clock.getDelta();
            uniforms.dT.value = clock.deltaTime;
            uniforms.time.value = clock.elapsedTime;

            looper._update();



            var angleSize = 1;
            var angleStart = 0.12;
            var corners = getPositionsAroundSkull(50.5, angleSize, angleStart, 0);
            var corners2 = getScreenCornersInWorld(camera, 250, .8
            );
            var cornerRotations = getRotationsAroundSkull(angleSize, angleStart);

            for (var i = 0; i < 4; i++) {
                cornerLinks[i].position.lerp(corners[i].lerp(corners2[i], Math.min(uniforms.time.value / 10, 1)), .04);//).set(corners[i].x, corners[i].y, corners[i].z);// = sphere;

                cornerLinks[i].quaternion.copy(cornerRotations[i]);//.slerp(cornerRotations[i], 1);
                cornerLinks[i].updateMatrixWorld();

                cornerLinks[i].text.position.copy(cornerLinks[i].position.clone().add(new THREE.Vector3(0, 0, 10)));
            }



            var angleSize = 1;
            var angleStart = .64;
            var corners = getPositionsAroundSkull(1.5, angleSize, angleStart, 0);
            var cornerRotations = getRotationsAroundSkull(angleSize, angleStart);

            for (var i = 0; i < 4; i++) {
                musicCornerLinks[i].position.lerp(corners[i], .04);
                musicCornerLinks[i].quaternion.copy(cornerRotations[i]);
                musicCornerLinks[i].updateMatrixWorld();

                musicCornerLinks[i].text.position.copy(musicCornerLinks[i].position.clone().add(new THREE.Vector3(0, 0, 1)));
            }


            var cLength = camera.position.sub(camControls.target).length();
            var dir = camera.position.sub(camControls.target).normalize();

            var nLength = lerp(cLength, camControls.desiredZoom, .01);

            dir.multiplyScalar(nLength)

            camera.position.copy(dir.add(camControls.target));



            renderer.render(scene, camera);

        }




        /*


        
 __ __  ______  ____  _       _____
|  T  T|      Tl    j| T     / ___/
|  |  ||      | |  T | |    (   \_ 
|  |  |l_j  l_j |  | | l___  \__  T
|  :  |  |  |   |  | |     T /  \ |
l     |  |  |   j  l |     | \    |
 \__,_j  l__j  |____jl_____j  \___j
        


        */
        function lerp(a, b, alpha) {
            return a + alpha * (b - a);
        }

        var frontText = document.getElementById("frontText");
        function clickLink(text) {
            frontText.innerHTML = text;
            setTimeout(function () {
                frontText.innerHTML = "";
            }, 1000);
        }


        function ToggleCameraPosition() {
            var cc = camControls;
            if (cc.desiredZoom == 140) {
                cc.desiredZoom = 5;
                cc.target = new THREE.Vector3(0, 0, 0);
            } else {
                cc.desiredZoom = 140;
                cc.target = new THREE.Vector3(0, 0, 0);
            }
        }


        function CornerLink(params) {

        }




        function SkullLink(params) {


            var vs1 = params.vertexShader;
            var fs1 = params.fragmentShader;
            var geo = params.geometry;
            var shield = params.shield;
            var uniforms = params.uniforms;
            var linkInfo = params.linkInfo;
            var scale = params.scale;
            var controls = params.controls;
            var scene = params.scene;

            print("UNI");
            print(uniforms.t_matcap);

            var uniforms2 = {
                dT: uniforms.dT,
                time: uniforms.time,
                lightPos: uniforms.lightPos,
                t_matcap: uniforms.t_matcap,
                t_normal: uniforms.t_normal,

                t_audio: uniforms.t_audio,
                _NoiseSize: { type: "f", value: 2.1 },
                _NoiseSpeed: { type: "f", value: .2 },
                _NoiseOffset: { type: "f", value: .3 },
                _HueStart: { type: "f", value: .8 },
                _HueSize: { type: "f", value: .05 },
                _NormalDepth: { type: "f", value: .1 },
                _FFTStart: { type: "f", value: .1 },
                _FFTSize: { type: "f", value: 1 },
                _Saturation: { type: "f", value: 1 },
                _Lightness: { type: "f", value: 11 },
                _DiscardAmount: { type: "f", value: 0 }


            }

            var hueStart = { type: "f", value: .1 }
            var hueSize = { type: "f", value: .1 }
            var sphereMaterial = new THREE.ShaderMaterial({
                uniforms: uniforms2,
                vertexShader: vs1,
                fragmentShader: fs1,
                side: THREE.DoubleSide
            })

            sphereMaterial.extensions.derivatives = true;

            var mat = new THREE.MeshNormalMaterial();

            var main = new THREE.Mesh(geo, sphereMaterial);
            scene.add(main);
            main.linkInfo = linkInfo;
            main.scale.x = scale;
            main.scale.y = scale;
            main.scale.z = scale;
            main.select = function () {
                clickLink(this.linkInfo);
            }
            controls.add(main);

            var transparentMaterial = new THREE.MeshBasicMaterial({
                transparent: true,
                opacity: 0,
                depthWrite: false,
            });

            var shield = new THREE.Mesh(shield, transparentMaterial);
            main.add(shield);
            shield.scale.x = 1;
            shield.scale.y = 1;
            shield.scale.z = 1;
            shield.shieldedMesh = main;
            shield.hueStart = hueStart;
            shield.hueSize = hueSize;
            shield.linkInfo = linkInfo;
            shield.linkMat = mat;
            shield.uniforms = uniforms2;
            shield.select = function () {

                print(this);
                this.uniforms._HueStart.value = .2;
                this.uniforms._HueSize.value = .5;



                clickLink(this.linkInfo);
            }
            shield.hueStart.value = 0;
            shield.hueSize.value = .01;
            shield.hoverOver = function () {

                print(this.uniforms);
                mat.color = new THREE.Color(0xff0000);
                this.uniforms._HueStart.value = 0.4;
                this.uniforms._HueSize.value = .3;
            }

            shield.hoverOut = function () {
                mat.color = new THREE.Color(0xffffff);
                this.uniforms._HueStart.value = 0;
                this.uniforms._HueSize.value = .3;
            }
            controls.add(shield);


            var link = {
                main: main,
                shield: shield
            }

            return link;


        }



        function AudioLoop(loop, val) {



            var geo = new THREE.IcosahedronGeometry(1, 4);

            var mat = new THREE.ShaderMaterial({
                uniforms: {

                    dT: uniforms.dT,
                    time: uniforms.time,
                    lightPos: uniforms.lightPos,
                    t_matcap: uniforms.t_matcap,
                    t_normal: uniforms.t_normal,
                    t_audio: uniforms.t_audio,

                    _NoiseSize: { type: "f", value: 1.1 },
                    _NoiseSpeed: { type: "f", value: .2 },
                    _NoiseOffset: { type: "f", value: .2 },
                    _HueStart: { type: "f", value: val },
                    _HueSize: { type: "f", value: .05 },
                    _NormalDepth: { type: "f", value: .1 },
                    _FFTStart: { type: "f", value: .1 },
                    _FFTSize: { type: "f", value: 1.1 },
                    _Saturation: { type: "f", value: 1 },
                    _Lightness: { type: "f", value: 1 },
                    _DiscardAmount: { type: "f", value: 0 }

                },
                vertexShader: vs1,
                fragmentShader: fs1,
                side: THREE.DoubleSide
            })


            mat.uniforms._Lightness.value = 1;//= new THREE.Color(0x000000);

            var main = new THREE.Mesh(geo, mat);
            scene.add(main);
            main.select = function () {
                print(this);
                this.toggleLoop();
            }.bind(main);
            main.loop = loop;
            main.loopOn = false;
            main.toggleLoop = function () {

                if (this.loopOn) {
                    console.log(this);
                    console.log(this.material);
                    this.material.uniforms._Lightness.value = 1;//color = new THREE.Color(0x000000);
                    this.loopOn = false;
                    this.loop.gainNode.gain.setValueAtTime(0, audio.ctx.currentTime);
                } else {

                    //   this.material.color = new THREE.Color(0xffffff);
                    this.loopOn = true;

                    this.material.uniforms._Lightness.value = 3;
                    this.loop.gainNode.gain.setValueAtTime(.4, audio.ctx.currentTime);
                }
            }


            main.hoverOver = function () {
                //this.material.color = new THREE.Color(0xaaaaaa);
                this.material.uniforms._Lightness.value = 2;
            }.bind(main);

            main.hoverOut = function () {


                this.material.uniforms._Lightness.value = 1;
                // this.material.color = new THREE.Color(0x000000);
                if (this.loopOn) {
                    this.material.uniforms._Lightness.value = 3;
                }
            }.bind(main);
            controls.add(main);

            return main;


        }




        function getPositionsAroundSkull(size, angleSize, angleStart, yOffset) {

            var corners = [];
            for (var i = 0; i < 4; i++) {

                var n = i / 4;
                var a = (n * angleSize + angleStart) * 6.28;

                var x = Math.cos(a) * size;
                var y = Math.sin(a) * size;
                corners.push(new THREE.Vector3(x, y + yOffset, 0));
            }

            return corners;


        }


        function getRotationsAroundSkull(angleSize, angleStart) {

            var corners = [];
            for (var i = 0; i < 4; i++) {

                var n = i / 4;
                var a = (n * angleSize + angleStart) * 6.28;

                const quaternion = new THREE.Quaternion();
                quaternion.setFromEuler(new THREE.Euler(0, 0, a));
                quaternion.multiply(new THREE.Quaternion().setFromEuler(new THREE.Euler(Math.PI / 2, 0, 0)));

                corners.push(quaternion);
            }

            return corners;


        }

        function onWindowResize() {

            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();

            renderer.setSize(window.innerWidth, window.innerHeight);

        }

        function onPointerMove(event) {

            pointer.x = (event.clientX / window.innerWidth) * 2 - 1;
            pointer.y = - (event.clientY / window.innerHeight) * 2 + 1;

        }


    </script>

</body>

</html>